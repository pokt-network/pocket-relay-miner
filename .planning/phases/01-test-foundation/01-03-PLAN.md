---
phase: 01-test-foundation
plan: 03
type: execute
wave: 2
depends_on: ["01-02"]
files_modified:
  - .github/workflows/ci.yml
  - .github/workflows/nightly-stability.yml
autonomous: true

must_haves:
  truths:
    - "CI runs all tests with race detection on every PR"
    - "CI fails on any govulncheck vulnerability (not just HIGH/CRITICAL)"
    - "Lint, test, and vuln-check run as parallel jobs"
    - "Nightly stability job runs test suite 100 times"
    - "Nightly job notifies on failure via GitHub Actions default mechanism"
  artifacts:
    - path: ".github/workflows/ci.yml"
      provides: "Updated CI with race tests and govulncheck"
      contains: "govulncheck"
    - path: ".github/workflows/ci.yml"
      provides: "Race-enabled tests via make test"
      contains: "make test"
    - path: ".github/workflows/nightly-stability.yml"
      provides: "Nightly 100-run stability check"
      contains: "test-stability.sh"
  key_links:
    - from: ".github/workflows/ci.yml"
      to: "Makefile"
      via: "CI invokes make test"
      pattern: "make test"
    - from: ".github/workflows/nightly-stability.yml"
      to: "scripts/test-stability.sh"
      via: "Nightly job runs stability script"
      pattern: "test-stability.sh"
---

<objective>
Update CI pipeline with vulnerability scanning and nightly stability checks

Purpose: Complete the CI infrastructure for Phase 1 by adding govulncheck (INFRA-03), ensuring race detection runs on every PR via `make test` (INFRA-01), and creating a nightly stability job for flaky test detection (QUAL-02). These changes make the quality gates enforceable.

Output: Updated CI workflow and new nightly stability workflow.
</objective>

<execution_context>
@/home/overlordyorch/.claude/get-shit-done/workflows/execute-plan.md
@/home/overlordyorch/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-test-foundation/01-CONTEXT.md
@.planning/phases/01-test-foundation/01-RESEARCH.md
@.github/workflows/ci.yml
@Makefile
@scripts/test-stability.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update CI workflow with govulncheck</name>
  <files>.github/workflows/ci.yml</files>
  <action>
Update `.github/workflows/ci.yml` to:

1. Add a new `vuln-check` job that runs govulncheck:
```yaml
  vuln-check:
    name: Vulnerability Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.24.3"
          cache: true

      - name: Run govulncheck
        uses: golang/govulncheck-action@v1
        with:
          go-package: ./...
```

2. Verify the `test` job continues to use `make test`:
   - After Plan 01-02 completes, `make test` will include `-race` by default
   - Do NOT change the test command - CI should continue to use `make test`
   - This ensures race detection is enabled via the Makefile (single source of truth)

3. Update the `docker-build-*` jobs to depend on `vuln-check`:
   - Change `needs: [lint, fmt, test]` to `needs: [lint, fmt, test, vuln-check]`

4. Keep lint, test, and vuln-check as parallel jobs (they don't depend on each other)

Per 01-CONTEXT.md decisions:
- "govulncheck fails on ALL known vulnerabilities (not just HIGH/CRITICAL)"
- "Race detection runs on every PR (all tests with -race flag)" - via `make test` from Plan 01-02
- "Lint, test, and vuln-check run in parallel jobs for faster feedback"
  </action>
  <verify>
1. YAML is valid: `python3 -c "import yaml; yaml.safe_load(open('.github/workflows/ci.yml'))"`
2. vuln-check job exists in the workflow
3. test job still uses `make test` (NOT explicit `go test -race`)
4. docker-build jobs depend on vuln-check
  </verify>
  <done>
CI workflow updated with govulncheck job. Docker builds now require vuln-check to pass. Test job uses `make test` which will include race detection after Plan 01-02.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create nightly stability workflow</name>
  <files>.github/workflows/nightly-stability.yml</files>
  <action>
Create `.github/workflows/nightly-stability.yml` for nightly 100-run stability checks:

```yaml
name: Nightly Stability

on:
  schedule:
    # Run at 2 AM UTC daily
    - cron: '0 2 * * *'
  workflow_dispatch:
    # Allow manual triggering for debugging

permissions:
  contents: read

jobs:
  stability:
    name: 100-Run Stability Test
    runs-on: ubuntu-latest
    timeout-minutes: 120  # 2 hours max (100 runs can take a while with race detection)
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.24.3"
          cache: true

      - name: Run 100-run stability test
        run: |
          chmod +x scripts/test-stability.sh
          ./scripts/test-stability.sh
        env:
          RUNS: 100

      # GitHub Actions sends email notifications on workflow failure by default
      # No additional notification setup needed per 01-RESEARCH.md open question #2
```

This workflow:
- Runs at 2 AM UTC daily (configurable per Claude's discretion in 01-CONTEXT.md)
- Can be manually triggered via workflow_dispatch
- Uses the stability script created in Plan 02
- Has a 2-hour timeout to handle the long-running 100 iterations
- Relies on GitHub's default failure notifications (per research recommendation)
  </action>
  <verify>
1. YAML is valid: `python3 -c "import yaml; yaml.safe_load(open('.github/workflows/nightly-stability.yml'))"`
2. Workflow has schedule trigger with cron expression
3. Workflow has workflow_dispatch for manual triggering
4. Workflow calls the stability script
  </verify>
  <done>
Nightly stability workflow created. Runs 100-iteration test suite daily and notifies on failure via GitHub Actions default mechanism.
  </done>
</task>

</tasks>

<verification>
1. `.github/workflows/ci.yml` contains vuln-check job
2. CI test job uses `make test` (which includes `-race` after Plan 01-02)
3. Docker builds depend on lint, fmt, test, AND vuln-check
4. `.github/workflows/nightly-stability.yml` exists
5. Nightly workflow has correct schedule (cron) and manual trigger (workflow_dispatch)
6. Nightly workflow calls `scripts/test-stability.sh`
7. Both YAML files pass syntax validation
</verification>

<success_criteria>
- CI workflow updated with govulncheck job that fails on any vulnerability
- CI test job uses `make test` (race detection comes from Plan 01-02 Makefile update)
- Nightly stability workflow runs 100-run stability test at 2 AM UTC
- All YAML files are syntactically valid
- Docker builds now require all quality gates to pass
</success_criteria>

<output>
After completion, create `.planning/phases/01-test-foundation/01-03-SUMMARY.md`
</output>
