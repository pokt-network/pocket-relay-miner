---
phase: 02-characterization-tests
plan: 05
type: execute
wave: 3
depends_on: ["02-02", "02-03", "02-04"]
files_modified:
  - Makefile
  - .github/workflows/ci.yml
  - scripts/test-coverage.sh
autonomous: true

must_haves:
  truths:
    - "Coverage reports generated for miner/, relayer/, cache/ packages"
    - "CI displays coverage percentage in logs"
    - "Coverage drops below 80% trigger warnings (not failures)"
    - "HTML coverage reports generated for local development"
  artifacts:
    - path: "scripts/test-coverage.sh"
      provides: "Coverage measurement script"
      exports: ["per-package coverage", "total coverage", "threshold checking"]
    - path: "Makefile"
      provides: "test-coverage target"
      contains: "test-coverage:"
    - path: ".github/workflows/ci.yml"
      provides: "Coverage reporting in CI"
      contains: "coverage"
  key_links:
    - from: "scripts/test-coverage.sh"
      to: "go test -coverprofile"
      via: "runs coverage collection"
      pattern: "go test.*-coverprofile"
    - from: ".github/workflows/ci.yml"
      to: "scripts/test-coverage.sh"
      via: "calls script in CI"
      pattern: "test-coverage"
---

<objective>
Add coverage tracking infrastructure with per-package measurement and CI integration.

Purpose: Enable visibility into test coverage for miner/, relayer/, and cache/ packages. Coverage warnings (not failures) help maintain the 80% target established in Phase 2.

Output: Coverage script, Makefile target, and CI integration with warning-only gates
</objective>

<execution_context>
@/home/overlordyorch/.claude/get-shit-done/workflows/execute-plan.md
@/home/overlordyorch/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-characterization-tests/02-RESEARCH.md
@.planning/phases/02-characterization-tests/02-CONTEXT.md

# Reference prior summaries for coverage context
@.planning/phases/02-characterization-tests/02-02-SUMMARY.md
@.planning/phases/02-characterization-tests/02-03-SUMMARY.md
@.planning/phases/02-characterization-tests/02-04-SUMMARY.md

# Existing CI and Makefile
@.github/workflows/ci.yml
@Makefile
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create coverage measurement script</name>
  <files>scripts/test-coverage.sh</files>
  <action>
Create scripts/test-coverage.sh with per-package coverage measurement:

```bash
#!/bin/bash
# test-coverage.sh - Measure test coverage for critical packages
# Usage: ./scripts/test-coverage.sh [--ci] [--html]
#
# Options:
#   --ci   Output in CI-friendly format (no colors, machine-parseable)
#   --html Generate HTML coverage report
#
# Exit codes:
#   0 - Success (coverage measured)
#   1 - Script error (not a coverage failure)
#
# Note: This script warns but does not fail on low coverage per Phase 2 decision.

set -e

CI_MODE=false
HTML_MODE=false
THRESHOLD=80
COVERDIR="coverage"

# Parse arguments
for arg in "$@"; do
  case $arg in
    --ci) CI_MODE=true ;;
    --html) HTML_MODE=true ;;
  esac
done

# Create coverage directory
mkdir -p "$COVERDIR"

# Packages to measure (critical paths)
PACKAGES=(
  "github.com/pokt-network/pocket-relay-miner/miner"
  "github.com/pokt-network/pocket-relay-miner/relayer"
  "github.com/pokt-network/pocket-relay-miner/cache"
)

# Collect coverage for each package
echo "Collecting coverage for critical packages..."

for pkg in "${PACKAGES[@]}"; do
  pkg_name=$(basename "$pkg")
  echo "  Testing $pkg_name..."
  go test -race -coverprofile="$COVERDIR/${pkg_name}.cover" -covermode=atomic "$pkg/..." 2>/dev/null || true
done

# Merge coverage files
echo "" > "$COVERDIR/combined.cover"
echo "mode: atomic" > "$COVERDIR/combined.cover"
for f in "$COVERDIR"/*.cover; do
  if [ -f "$f" ] && [ "$f" != "$COVERDIR/combined.cover" ]; then
    tail -n +2 "$f" >> "$COVERDIR/combined.cover"
  fi
done

# Generate HTML if requested
if [ "$HTML_MODE" = true ]; then
  go tool cover -html="$COVERDIR/combined.cover" -o "$COVERDIR/coverage.html"
  echo "HTML report: $COVERDIR/coverage.html"
fi

# Calculate per-package coverage
echo ""
echo "=== Coverage Summary ==="
echo ""

BELOW_THRESHOLD=false

for pkg in "${PACKAGES[@]}"; do
  pkg_name=$(basename "$pkg")
  if [ -f "$COVERDIR/${pkg_name}.cover" ]; then
    coverage=$(go tool cover -func="$COVERDIR/${pkg_name}.cover" 2>/dev/null | grep "total:" | awk '{print $3}' | tr -d '%')
    if [ -n "$coverage" ]; then
      if [ "$CI_MODE" = true ]; then
        echo "coverage:${pkg_name}:${coverage}%"
      else
        if (( $(echo "$coverage < $THRESHOLD" | bc -l) )); then
          echo "  $pkg_name: ${coverage}% (BELOW ${THRESHOLD}% target)"
          BELOW_THRESHOLD=true
        else
          echo "  $pkg_name: ${coverage}%"
        fi
      fi
    else
      echo "  $pkg_name: 0.0% (no tests or no coverage data)"
      BELOW_THRESHOLD=true
    fi
  fi
done

echo ""

# Total coverage
total_coverage=$(go tool cover -func="$COVERDIR/combined.cover" 2>/dev/null | grep "total:" | awk '{print $3}' | tr -d '%')
if [ -n "$total_coverage" ]; then
  if [ "$CI_MODE" = true ]; then
    echo "coverage:total:${total_coverage}%"
  else
    echo "Total coverage: ${total_coverage}%"
  fi
fi

# Warn but don't fail (per Phase 2 decision)
if [ "$BELOW_THRESHOLD" = true ]; then
  if [ "$CI_MODE" = true ]; then
    echo "::warning::Some packages below ${THRESHOLD}% coverage target"
  else
    echo ""
    echo "WARNING: Some packages below ${THRESHOLD}% coverage target"
  fi
fi

echo ""
echo "Coverage data: $COVERDIR/"
```

Make executable: `chmod +x scripts/test-coverage.sh`
  </action>
  <verify>
```bash
chmod +x scripts/test-coverage.sh
./scripts/test-coverage.sh
# Should output coverage percentages for miner/, relayer/, cache/
```
  </verify>
  <done>
- Script measures per-package coverage for miner/, relayer/, cache/
- HTML report generation works with --html flag
- CI-friendly output works with --ci flag
- Warns but doesn't fail on low coverage
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Makefile target and CI integration</name>
  <files>Makefile, .github/workflows/ci.yml</files>
  <action>
Update Makefile to add test-coverage target:

```makefile
# Add after existing test targets
.PHONY: test-coverage
test-coverage: ## Run tests with coverage measurement
	@./scripts/test-coverage.sh --html

.PHONY: test-coverage-ci
test-coverage-ci: ## Run tests with coverage (CI format)
	@./scripts/test-coverage.sh --ci
```

Update .github/workflows/ci.yml to add coverage step:

Add a new step after the test step in the test job:

```yaml
      - name: Run tests with coverage
        run: |
          ./scripts/test-coverage.sh --ci
        continue-on-error: true  # Warning only, don't fail CI

      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 7
        if: always()
```

The coverage step should:
1. Run after tests pass
2. Use continue-on-error: true (warning only per Phase 2 decision)
3. Upload coverage artifacts for inspection
  </action>
  <verify>
```bash
# Test Makefile target
make test-coverage

# Verify CI workflow is valid
cat .github/workflows/ci.yml | grep -A 10 "coverage"
```
  </verify>
  <done>
- `make test-coverage` runs coverage script with HTML output
- `make test-coverage-ci` runs with CI-friendly output
- CI workflow includes coverage step after tests
- Coverage step uses continue-on-error (warning only)
- Coverage artifacts uploaded to GitHub Actions
  </done>
</task>

</tasks>

<verification>
```bash
# Verify script works
./scripts/test-coverage.sh

# Verify HTML generation
./scripts/test-coverage.sh --html
ls -la coverage/coverage.html

# Verify CI mode
./scripts/test-coverage.sh --ci

# Verify Makefile targets
make test-coverage

# Verify CI workflow syntax
cat .github/workflows/ci.yml | yq .jobs.test.steps
```
</verification>

<success_criteria>
1. scripts/test-coverage.sh exists and is executable
2. Script measures coverage for miner/, relayer/, cache/ packages
3. Per-package coverage percentages displayed
4. HTML report generated with --html flag
5. CI-friendly output with --ci flag
6. `make test-coverage` target works
7. CI workflow includes coverage step (warning-only)
8. Coverage artifacts uploaded in CI
</success_criteria>

<output>
After completion, create `.planning/phases/02-characterization-tests/02-05-SUMMARY.md`
</output>
