---
phase: 02-characterization-tests
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - testutil/testutil.go
  - testutil/keys.go
  - testutil/session_builder.go
  - testutil/relay_builder.go
  - testutil/redis_suite.go
autonomous: true

must_haves:
  truths:
    - "Test utilities are importable from miner/, relayer/, cache/ packages"
    - "Deterministic test data generation produces identical output for same seed"
    - "Redis test suite provides shared miniredis instance with test isolation"
    - "Test keys are hardcoded and committed to repo"
  artifacts:
    - path: "testutil/testutil.go"
      provides: "Test mode detection, concurrency helpers"
      exports: ["GetTestConcurrency", "GetTestIterations", "IsNightlyMode"]
    - path: "testutil/keys.go"
      provides: "Hardcoded test cryptographic keys"
      exports: ["TestSupplierPrivKey", "TestAppPrivKey", "TestSupplierAddress", "TestAppAddress"]
    - path: "testutil/session_builder.go"
      provides: "Deterministic session snapshot builder"
      exports: ["SessionBuilder"]
    - path: "testutil/relay_builder.go"
      provides: "Deterministic relay request builder"
      exports: ["RelayBuilder"]
    - path: "testutil/redis_suite.go"
      provides: "Base test suite with miniredis"
      exports: ["RedisTestSuite"]
  key_links:
    - from: "testutil/redis_suite.go"
      to: "miniredis.Miniredis"
      via: "embedded instance in suite"
      pattern: "miniredis\\.Run"
    - from: "testutil/session_builder.go"
      to: "miner.SessionSnapshot"
      via: "builder produces snapshot"
      pattern: "\\*miner\\.SessionSnapshot"
---

<objective>
Create shared test utilities for characterization tests across miner/, relayer/, and cache/ packages.

Purpose: Establish reusable test infrastructure that enforces Rule #1 compliance (no flaky tests, no race conditions, no mock/fake tests) with deterministic data generation and proper Redis test isolation.

Output: testutil/ package with builders, helpers, and base test suite
</objective>

<execution_context>
@/home/overlordyorch/.claude/get-shit-done/workflows/execute-plan.md
@/home/overlordyorch/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-characterization-tests/02-RESEARCH.md
@.planning/phases/02-characterization-tests/02-CONTEXT.md

# Reference existing test patterns
@miner/redis_smst_utils_test.go
@miner/claim_pipeline_test.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create testutil package foundation</name>
  <files>testutil/testutil.go, testutil/keys.go</files>
  <action>
Create testutil/testutil.go with:
- GetTestConcurrency() returning 100 for CI, 1000 for nightly (check TEST_MODE env)
- GetTestIterations() returning 10 for CI, 100 for nightly
- IsNightlyMode() bool helper
- GenerateDeterministicBytes(seed int, length int) []byte using deterministic PRNG

Create testutil/keys.go with:
- Hardcoded hex-encoded private keys for testing (NOT randomly generated each run)
- TestSupplierPrivKey, TestSupplierPubKey, TestSupplierAddress constants
- TestAppPrivKey, TestAppPubKey, TestAppAddress constants
- Use secp256k1 keys compatible with Cosmos SDK
- Include //go:build test constraint to prevent accidental production use

Generate deterministic test keys using a known seed, NOT crypto/rand:
```go
// Example: Use a fixed seed to generate reproducible keys
var TestSupplierPrivKeyHex = "..."  // Pre-generated, committed
var TestAppPrivKeyHex = "..."       // Pre-generated, committed
```
  </action>
  <verify>
- `go build ./testutil/...` succeeds
- `go test -run TestDeterminism ./testutil/...` shows identical output for same seeds
  </verify>
  <done>
- testutil/ package compiles
- GetTestConcurrency() returns 100 by default, 1000 when TEST_MODE=nightly
- Keys are hardcoded and identical across all test runs
  </done>
</task>

<task type="auto">
  <name>Task 2: Create builder patterns for test data</name>
  <files>testutil/session_builder.go, testutil/relay_builder.go</files>
  <action>
Create testutil/session_builder.go with SessionBuilder:
```go
type SessionBuilder struct {
    seed int
    // configurable fields with defaults
}

func NewSessionBuilder(seed int) *SessionBuilder
func (b *SessionBuilder) WithSupplier(addr string) *SessionBuilder
func (b *SessionBuilder) WithApp(addr string) *SessionBuilder
func (b *SessionBuilder) WithService(id string) *SessionBuilder
func (b *SessionBuilder) WithState(state miner.SessionState) *SessionBuilder
func (b *SessionBuilder) WithBlockHeights(start, end int64) *SessionBuilder
func (b *SessionBuilder) WithRelayCount(count int64) *SessionBuilder
func (b *SessionBuilder) Build() *miner.SessionSnapshot
func (b *SessionBuilder) BuildN(n int) []*miner.SessionSnapshot
```

Create testutil/relay_builder.go with RelayBuilder:
```go
type RelayBuilder struct {
    seed int
    // configurable fields
}

func NewRelayBuilder(seed int) *RelayBuilder
func (b *RelayBuilder) WithSessionID(id string) *RelayBuilder
func (b *RelayBuilder) WithPayload(payload []byte) *RelayBuilder
func (b *RelayBuilder) WithWeight(weight uint64) *RelayBuilder
func (b *RelayBuilder) Build() *testRelay  // key, value, weight
func (b *RelayBuilder) BuildN(n int) []testRelay
```

Key requirements:
- Same seed MUST produce identical output every time (determinism)
- Use math/rand with seed for randomization, NOT crypto/rand
- Include //go:build test constraint
  </action>
  <verify>
```bash
go test -run TestSessionBuilder -v ./testutil/...
go test -run TestRelayBuilder -v ./testutil/...
```
Both should show deterministic output.
  </verify>
  <done>
- SessionBuilder produces identical snapshots for same seed
- RelayBuilder produces identical relays for same seed
- Both pass race detector
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Redis test suite base</name>
  <files>testutil/redis_suite.go, testutil/testutil_test.go</files>
  <action>
Create testutil/redis_suite.go with RedisTestSuite:
```go
// RedisTestSuite provides a shared miniredis instance for tests.
// Embed this in your test suite to get automatic Redis setup/teardown.
//
// Usage:
//   type MyTestSuite struct {
//       testutil.RedisTestSuite
//   }
type RedisTestSuite struct {
    suite.Suite
    MiniRedis   *miniredis.Miniredis
    RedisClient *redisutil.Client
    Ctx         context.Context
}

func (s *RedisTestSuite) SetupSuite()    // Create miniredis once
func (s *RedisTestSuite) SetupTest()     // FlushAll before each test
func (s *RedisTestSuite) TearDownSuite() // Close miniredis

// Helper methods
func (s *RedisTestSuite) RequireKeyExists(key string)
func (s *RedisTestSuite) RequireKeyNotExists(key string)
func (s *RedisTestSuite) GetKeyCount() int
```

Create testutil/testutil_test.go with verification tests:
- TestGetTestConcurrency verifies env var behavior
- TestDeterministicBytes verifies same seed = same output
- TestSessionBuilderDeterminism verifies reproducibility
- TestRelayBuilderDeterminism verifies reproducibility
- TestRedisTestSuite_Isolation verifies FlushAll between tests

Ensure all tests pass with `-race` flag.
  </action>
  <verify>
```bash
go test -race -v ./testutil/...
```
All tests pass with race detection enabled.
  </verify>
  <done>
- RedisTestSuite embeddable in other test suites
- All testutil package tests pass with -race flag
- Test isolation verified (FlushAll between tests)
  </done>
</task>

</tasks>

<verification>
```bash
# Verify package compiles
go build ./testutil/...

# Verify all tests pass with race detection
go test -race -v ./testutil/...

# Verify determinism (run twice, compare output)
go test -v -run TestDeterminism ./testutil/... 2>&1 | tee /tmp/run1.txt
go test -v -run TestDeterminism ./testutil/... 2>&1 | tee /tmp/run2.txt
diff /tmp/run1.txt /tmp/run2.txt  # Should show no differences
```
</verification>

<success_criteria>
1. testutil/ package exists and compiles
2. Builders produce deterministic output for same seed
3. RedisTestSuite provides shared miniredis with test isolation
4. All tests pass with -race flag
5. No flaky tests (100% pass rate on 10 consecutive runs)
</success_criteria>

<output>
After completion, create `.planning/phases/02-characterization-tests/02-01-SUMMARY.md`
</output>
