---
phase: 02-characterization-tests
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/test-coverage.sh
  - testutil/testutil.go
  - testutil/keys.go
  - testutil/session_builder.go
  - testutil/relay_builder.go
  - testutil/redis_suite.go
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "scripts/test-coverage.sh uses -tags test flag for accurate coverage measurement"
    - "testutil package has no import cycle preventing usage from miner, relayer, or cache tests"
  artifacts:
    - path: "scripts/test-coverage.sh"
      provides: "Accurate coverage measurement with -tags test"
      contains: "-tags test"
    - path: "testutil/testutil.go"
      provides: "Shared test utilities without import cycles"
  key_links:
    - from: "scripts/test-coverage.sh"
      to: "go test"
      via: "-tags test flag"
      pattern: "-tags test"
---

<objective>
Fix infrastructure gaps blocking accurate coverage measurement and shared test utility usage.

Purpose: The coverage script reports misleading numbers (miner shows 2% without -tags test vs 32.4% with it). The testutil package was created but cannot be imported by miner or relayer tests due to import cycles (testutil imports miner types). These two issues must be resolved before coverage improvement plans can execute accurately.

Output:
1. Fixed scripts/test-coverage.sh with -tags test flag
2. Refactored testutil package that breaks the import cycle (remove miner/relayer dependencies, use only stdlib + third-party types)
</objective>

<execution_context>
@/home/overlordyorch/.claude/get-shit-done/workflows/execute-plan.md
@/home/overlordyorch/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-characterization-tests/02-VERIFICATION.md
@.planning/phases/02-characterization-tests/02-01-SUMMARY.md
@scripts/test-coverage.sh
@testutil/testutil.go
@testutil/keys.go
@testutil/session_builder.go
@testutil/relay_builder.go
@testutil/redis_suite.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix coverage script and refactor testutil package</name>
  <files>
    scripts/test-coverage.sh
    testutil/testutil.go
    testutil/keys.go
    testutil/session_builder.go
    testutil/relay_builder.go
    testutil/redis_suite.go
  </files>
  <action>
    **Part A: Fix coverage script**

    In `scripts/test-coverage.sh`, line 46, add `-tags test` to the go test command:
    ```
    # Before:
    go test -race -coverprofile="$COVERDIR/${pkg_name}.cover" -covermode=atomic "$pkg/..." 2>/dev/null || true

    # After:
    go test -tags test -race -coverprofile="$COVERDIR/${pkg_name}.cover" -covermode=atomic "$pkg/..." 2>/dev/null || true
    ```

    **Part B: Break testutil import cycle**

    The import cycle is: testutil imports miner (for SessionSnapshot type) -> miner tests cannot import testutil.

    Resolution strategy: Remove ALL imports of miner/, relayer/, and cache/ packages from testutil. Instead:

    1. Read each testutil file and identify imports from `github.com/pokt-network/pocket-relay-miner/miner`, `github.com/pokt-network/pocket-relay-miner/relayer`, or `github.com/pokt-network/pocket-relay-miner/cache`.

    2. For each such import, either:
       a. Replace with the underlying type from poktroll (e.g., use `sessiontypes.Session` directly instead of `miner.SessionSnapshot`)
       b. Define a minimal local interface/struct in testutil that captures just the fields needed
       c. Remove the function if it's tightly coupled to internal types

    3. The testutil package should ONLY import:
       - Standard library (context, fmt, math/rand, etc.)
       - Third-party libraries (miniredis, testify, redis client, poktroll proto types)
       - Internal utility packages that don't import miner/relayer/cache (e.g., transport/redis, logging)

    4. Verify the refactored testutil package compiles:
       ```bash
       go build -tags test ./testutil/...
       ```

    5. Verify no circular imports:
       ```bash
       go vet -tags test ./testutil/... ./miner/... ./relayer/... ./cache/...
       ```

    **Important:** Do NOT change existing miner or relayer test files in this plan. Those will be updated in subsequent plans.
  </action>
  <verify>
    ```bash
    # Coverage script uses -tags test
    grep -q "\-tags test" scripts/test-coverage.sh

    # testutil compiles without import cycles
    go build -tags test ./testutil/...

    # testutil does NOT import miner, relayer, or cache
    ! grep -r '"github.com/pokt-network/pocket-relay-miner/miner"' testutil/
    ! grep -r '"github.com/pokt-network/pocket-relay-miner/relayer"' testutil/
    ! grep -r '"github.com/pokt-network/pocket-relay-miner/cache"' testutil/

    # Coverage script runs and reports numbers
    ./scripts/test-coverage.sh 2>&1 | head -20
    ```
  </verify>
  <done>
    Coverage script includes -tags test flag. testutil package compiles with zero imports from miner/, relayer/, or cache/ packages. No import cycles exist.
  </done>
</task>

</tasks>

<verification>
1. `grep -c "\-tags test" scripts/test-coverage.sh` returns >= 1
2. `go build -tags test ./testutil/...` succeeds
3. `go vet -tags test ./testutil/... ./miner/... ./relayer/...` succeeds (no import cycles)
4. testutil/testutil_test.go passes: `go test -tags test ./testutil/...`
5. Existing tests still pass: `make test`
</verification>

<success_criteria>
- scripts/test-coverage.sh reports accurate coverage with -tags test
- testutil package has zero imports from miner/, relayer/, or cache/
- All existing tests pass without regression
</success_criteria>

<output>
After completion, create `.planning/phases/02-characterization-tests/02-06-SUMMARY.md`
</output>
