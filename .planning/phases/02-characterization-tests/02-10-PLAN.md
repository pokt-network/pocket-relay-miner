---
phase: 02-characterization-tests
plan: 10
type: execute
wave: 2
depends_on: [02-06]
files_modified:
  - relayer/validator_test.go
  - relayer/middleware_test.go
  - relayer/relay_meter_test.go
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Invalid relay requests (missing service ID, bad signature, expired session) are rejected with specific error codes"
    - "Valid relay requests pass validation and proceed to backend forwarding"
    - "Middleware chain applies request logging, panic recovery, and CORS in correct order"
    - "Relay meter accurately tracks compute unit accumulation per session in Redis"
    - "All new relayer tests pass with -race flag"
    - "Relayer/ coverage reaches >= 25% (up from 6.8% baseline; 80% enforcement deferred to Phase 6 per ROADMAP.md success criterion 2)"
  artifacts:
    - path: "relayer/validator_test.go"
      provides: "Validator characterization tests"
      min_lines: 200
    - path: "relayer/middleware_test.go"
      provides: "Middleware characterization tests"
      min_lines: 200
    - path: "relayer/relay_meter_test.go"
      provides: "Relay meter characterization tests"
      min_lines: 200
  key_links:
    - from: "relayer/validator_test.go"
      to: "relayer/validator.go"
      via: "Direct function calls"
      pattern: "Validat"
    - from: "relayer/middleware_test.go"
      to: "relayer/middleware.go"
      via: "HTTP handler chain testing"
      pattern: "Middleware\\|middleware"
    - from: "relayer/relay_meter_test.go"
      to: "relayer/relay_meter.go"
      via: "Direct function calls with miniredis"
      pattern: "RelayMeter\\|Meter"
    - from: "relayer/validator_test.go"
      to: "testutil/keys.go"
      via: "Import for deterministic test keys and ring signatures"
      pattern: "testutil\\.TestKeys\\|testutil\\.SupplierKey"
    - from: "relayer/relay_meter_test.go"
      to: "testutil/redis_suite.go"
      via: "Import for miniredis setup helpers"
      pattern: "testutil\\.NewRedisTestSuite\\|testutil\\.Redis"
    - from: "relayer/validator_test.go"
      to: "testutil/relay_builder.go"
      via: "Import for deterministic relay request test data"
      pattern: "testutil\\.NewRelayBuilder\\|testutil\\.Relay"
---

<objective>
Add characterization tests for critical relayer components to increase relayer/ coverage toward 80%.

Purpose: Relayer coverage is at 6.8%. The validator (validates relay requests), middleware (request/response processing chain), and relay meter (tracks stake consumption) are core components on the hot path. Every relay request passes through these components, making them critical for correctness and performance.

Output: Three new test files characterizing validator, middleware, and relay meter behavior
</objective>

<execution_context>
@/home/overlordyorch/.claude/get-shit-done/workflows/execute-plan.md
@/home/overlordyorch/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-characterization-tests/02-VERIFICATION.md
@.planning/phases/02-characterization-tests/02-04-SUMMARY.md
@relayer/validator.go
@relayer/middleware.go
@relayer/relay_meter.go
@relayer/proxy_test.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create validator and middleware characterization tests</name>
  <files>
    relayer/validator_test.go
    relayer/middleware_test.go
  </files>
  <action>
    **Build tag:** `//go:build test` at the top of both files.

    **validator_test.go:**

    Read `relayer/validator.go` (307 lines) to understand:
    - What fields are validated on relay requests
    - How ring signature verification works in the validator
    - What error codes/messages are returned for different validation failures
    - How session validation interacts with the cache

    Create tests following patterns from proxy_test.go (local mocks, httptest):

    1. **TestValidator_ValidRequest**: Well-formed relay request passes validation
    2. **TestValidator_MissingServiceID**: Request without service ID fails with specific error
    3. **TestValidator_MissingSessionHeader**: Request without session header fails validation
    4. **TestValidator_InvalidSignature**: Request with bad ring signature fails
    5. **TestValidator_ExpiredSession**: Request for expired session fails validation
    6. **TestValidator_UnknownApplication**: Request from unknown application fails
    7. **TestValidator_ConcurrentValidation**: Multiple concurrent validations are thread-safe

    **middleware_test.go:**

    Read `relayer/middleware.go` to understand:
    - What middleware functions are applied (logging, metrics, recovery, CORS, etc.)
    - How the middleware chain is constructed
    - What headers are set on responses
    - How panics are recovered

    Create tests:

    1. **TestMiddleware_RequestLogging**: Middleware logs request details
    2. **TestMiddleware_PanicRecovery**: Middleware recovers from handler panics and returns 500
    3. **TestMiddleware_CORS**: CORS headers are set correctly on responses
    4. **TestMiddleware_RequestID**: Request ID is generated and attached to context
    5. **TestMiddleware_ContentType**: Content-Type header is validated/set
    6. **TestMiddleware_ChainOrder**: Middleware executes in correct order

    **Pattern:** Use `httptest.NewRecorder()` and `http.NewRequest()` for testing middleware in isolation. Use `testutil/keys.go` for deterministic test keys and `testutil/relay_builder.go` for relay request test data (plan 06 fixes the import cycle). Use local mock types only for relayer-specific dependencies that testutil cannot provide (e.g., mock cache, mock session lookups).
  </action>
  <verify>
    ```bash
    # Tests compile
    go build -tags test ./relayer/...

    # Tests pass with race detector
    go test -tags test -race -v -run "TestValidator|TestMiddleware" ./relayer/...

    # Tests pass with shuffle
    go test -tags test -race -shuffle=on -run "TestValidator|TestMiddleware" ./relayer/...
    ```
  </verify>
  <done>
    validator_test.go has 7+ tests. middleware_test.go has 6+ tests. All pass with -race and -shuffle=on.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create relay meter characterization tests</name>
  <files>relayer/relay_meter_test.go</files>
  <action>
    **Build tag:** `//go:build test` at the top of file.

    Read `relayer/relay_meter.go` to understand:
    - How relay metering tracks stake consumption per session
    - How Redis is used for meter data (ha:meter:{sessionID} hash)
    - The eager vs optimistic metering modes
    - How compute units are tracked
    - How meter cleanup works

    Create tests using miniredis:

    1. **TestRelayMeter_RecordRelay**: Record a relay and verify meter data in Redis
    2. **TestRelayMeter_ComputeUnitsAccumulation**: Multiple relays accumulate compute units correctly
    3. **TestRelayMeter_SessionIsolation**: Meters for different sessions are independent
    4. **TestRelayMeter_StakeExceeded**: Meter detects when stake is exceeded (if applicable)
    5. **TestRelayMeter_EagerMode**: Eager mode records synchronously before responding
    6. **TestRelayMeter_OptimisticMode**: Optimistic mode records asynchronously after responding
    7. **TestRelayMeter_Cleanup**: Meter cleanup removes session data
    8. **TestRelayMeter_ConcurrentRecording**: Multiple concurrent recordings for same session are safe

    **Pattern:** Use suite-based tests with miniredis via `testutil/redis_suite.go`. Use `testutil/keys.go` for test keys. Create helper functions for setting up meter with mock dependencies. Use local mock types only for relayer-specific dependencies (cache interfaces, session lookups) that testutil cannot provide.

    **Important:** The relay meter is on the hot path (called for every relay). Tests should characterize actual behavior, including Redis key patterns and data formats stored.
  </action>
  <verify>
    ```bash
    # Tests compile
    go build -tags test ./relayer/...

    # Tests pass with race detector
    go test -tags test -race -v -run TestRelayMeter ./relayer/...

    # Tests pass with shuffle
    go test -tags test -race -shuffle=on -run TestRelayMeter ./relayer/...

    # Run coverage to see improvement
    go test -tags test -race -coverprofile=/tmp/relayer.cover ./relayer/... && go tool cover -func=/tmp/relayer.cover | grep total
    ```
  </verify>
  <done>
    relay_meter_test.go has 8+ tests. All pass with -race and -shuffle=on. Relayer coverage is >= 25% (up from 6.8% baseline).
  </done>
</task>

</tasks>

<verification>
1. `go test -tags test -race -v -run "TestValidator|TestMiddleware|TestRelayMeter" ./relayer/...` passes
2. `go test -tags test -race -shuffle=on -count=3 ./relayer/...` passes (no flaky tests)
3. Combined: 21+ new tests across 3 files
4. Relayer coverage >= 25% (up from 6.8% baseline; 80% enforcement deferred to Phase 6)
</verification>

<success_criteria>
- Validator, middleware, and relay meter have characterization tests
- All new tests pass -race and -shuffle=on deterministically
- Relayer/ coverage >= 25% (80% enforcement deferred to Phase 6 per ROADMAP.md success criterion 2)
</success_criteria>

<output>
After completion, create `.planning/phases/02-characterization-tests/02-10-SUMMARY.md`
</output>
