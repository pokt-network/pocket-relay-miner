---
phase: 02-characterization-tests
plan: 08
type: execute
wave: 2
depends_on: [02-06]
files_modified:
  - relayer/relay_grpc_service_test.go
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "gRPC transport has characterization tests covering unary relay, streaming, and error handling"
    - "gRPC tests pass with -race flag and -shuffle=on"
    - "gRPC tests use real gRPC client/server (not mocks)"
  artifacts:
    - path: "relayer/relay_grpc_service_test.go"
      provides: "gRPC transport characterization tests"
      min_lines: 300
  key_links:
    - from: "relayer/relay_grpc_service_test.go"
      to: "relayer/relay_grpc_service.go"
      via: "gRPC test server and client"
      pattern: "RelayGRPC\\|grpc\\.NewServer\\|grpc\\.Dial"
---

<objective>
Add gRPC transport characterization tests to close CHAR-03 gap.

Purpose: CHAR-03 requires tests for all transport protocols. HTTP and SSE streaming are tested but gRPC is missing. The gRPC relay service (577 lines in relay_grpc_service.go + 97 lines in grpc_interceptor.go) handles gRPC relay traffic. Tests must characterize unary relay handling, error responses, metadata forwarding, and concurrent request handling.

Output: relayer/relay_grpc_service_test.go with comprehensive gRPC transport tests
</objective>

<execution_context>
@/home/overlordyorch/.claude/get-shit-done/workflows/execute-plan.md
@/home/overlordyorch/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-characterization-tests/02-VERIFICATION.md
@.planning/phases/02-characterization-tests/02-04-SUMMARY.md
@relayer/relay_grpc_service.go
@relayer/grpc_interceptor.go
@relayer/grpc_web.go
@relayer/proxy.go
@relayer/proxy_test.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create gRPC transport characterization tests</name>
  <files>relayer/relay_grpc_service_test.go</files>
  <action>
    Create `relayer/relay_grpc_service_test.go` with characterization tests for the gRPC transport layer.

    **Build tag:** `//go:build test` at the top of file.

    **Test approach:**
    - Use `google.golang.org/grpc/test/bufconn` for in-process gRPC testing (no real network)
    - OR use `net.Listen("tcp", "127.0.0.1:0")` with `grpc.NewServer()` and `grpc.Dial()`
    - Follow the same local mock patterns established in proxy_test.go
    - All tests must be deterministic and pass `-race`

    **Required test cases (characterizing relay_grpc_service.go behavior):**

    1. **TestGRPCRelay_UnarySuccess**: Valid unary gRPC relay request returns correct response with supplier signature
    2. **TestGRPCRelay_MissingServiceID**: Request without service ID metadata returns appropriate gRPC status error
    3. **TestGRPCRelay_MissingSupplierAddress**: Request without supplier address returns appropriate gRPC status error
    4. **TestGRPCRelay_InvalidPayload**: Malformed relay payload returns appropriate gRPC error
    5. **TestGRPCRelay_BackendTimeout**: Backend gRPC server timeout returns DeadlineExceeded or appropriate error
    6. **TestGRPCRelay_BackendUnavailable**: Backend gRPC server down returns Unavailable status
    7. **TestGRPCInterceptor_MetadataForwarding**: Verify gRPC metadata (headers) are forwarded correctly to backend
    8. **TestGRPCInterceptor_ErrorMapping**: Verify gRPC status codes from backend are preserved/mapped correctly
    9. **TestGRPCConcurrent_MultipleRequests**: Many concurrent unary requests are handled independently
    10. **TestGRPCWeb_ContentTypeDetection**: gRPC-Web content type is detected and handled (if applicable from grpc_web.go)

    **Study these files first:**
    - `relay_grpc_service.go`: How gRPC relay requests are received, validated, forwarded, and responses signed
    - `grpc_interceptor.go`: What interceptors are applied and what metadata is forwarded
    - `grpc_web.go`: How gRPC-Web requests are detected and handled

    **Pattern for each test:**
    ```go
    func TestGRPCRelay_CaseName(t *testing.T) {
        // 1. Create backend gRPC server (mock service implementation)
        // 2. Create relay gRPC service with mock dependencies
        // 3. Create gRPC client connection
        // 4. Execute test scenario (send relay request)
        // 5. Assert expected behavior (response, status code, metadata)
        // 6. Clean up (server.Stop(), conn.Close())
    }
    ```

    **Important constraints:**
    - Do NOT use time.Sleep for synchronization
    - Do NOT import testutil (use local helpers consistent with proxy_test.go patterns)
    - Use real gRPC client/server infrastructure, not mocks
    - Document any surprising behavior discovered (as comments, not fixes)
    - Verify gRPC status codes in assertions (codes.OK, codes.InvalidArgument, etc.)
  </action>
  <verify>
    ```bash
    # Tests compile
    go build -tags test ./relayer/...

    # Tests pass with race detector
    go test -tags test -race -v -run TestGRPC ./relayer/...

    # Tests pass with shuffle
    go test -tags test -race -shuffle=on ./relayer/...

    # No flaky failures (run 5 times)
    for i in $(seq 1 5); do go test -tags test -race -shuffle=on -run TestGRPC ./relayer/... || exit 1; done
    ```
  </verify>
  <done>
    relayer/relay_grpc_service_test.go exists with 10+ gRPC characterization tests. All pass with -race and -shuffle=on. No flaky failures in 5 consecutive runs.
  </done>
</task>

</tasks>

<verification>
1. `go test -tags test -race -v -run TestGRPC ./relayer/...` passes all gRPC tests
2. `go test -tags test -race -shuffle=on -count=5 ./relayer/...` passes (no flaky tests)
3. gRPC test file has >= 300 lines of test code
4. Tests cover: unary relay, metadata forwarding, error handling, concurrent requests
</verification>

<success_criteria>
- gRPC transport has comprehensive characterization tests
- All tests pass -race and -shuffle=on deterministically
- CHAR-03 gRPC gap is closed
</success_criteria>

<output>
After completion, create `.planning/phases/02-characterization-tests/02-08-SUMMARY.md`
</output>
