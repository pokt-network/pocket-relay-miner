---
phase: 02-characterization-tests
plan: 07
type: execute
wave: 2
depends_on: [02-06]
files_modified:
  - relayer/websocket_test.go
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "WebSocket transport has characterization tests covering upgrade, message relay, and connection lifecycle"
    - "WebSocket tests pass with -race flag and -shuffle=on"
    - "WebSocket tests use real gorilla/websocket client (not mocks)"
  artifacts:
    - path: "relayer/websocket_test.go"
      provides: "WebSocket transport characterization tests"
      min_lines: 300
  key_links:
    - from: "relayer/websocket_test.go"
      to: "relayer/websocket.go"
      via: "Direct function calls and httptest.Server"
      pattern: "handleWebSocket\\|upgradeWebSocket\\|WebSocket"
    - from: "relayer/websocket_test.go"
      to: "testutil/keys.go"
      via: "Import for deterministic test keys"
      pattern: "testutil\\.TestKeys\\|testutil\\.SupplierKey"
    - from: "relayer/websocket_test.go"
      to: "testutil/redis_suite.go"
      via: "Import for miniredis setup helpers"
      pattern: "testutil\\.NewRedisTestSuite\\|testutil\\.Redis"
---

<objective>
Add WebSocket transport characterization tests to close CHAR-03 gap.

Purpose: CHAR-03 requires tests for all transport protocols. HTTP and SSE streaming are tested but WebSocket is missing. WebSocket handling in proxy.go (1149 lines in websocket.go) is a critical transport for real-time relay traffic. Tests must characterize the upgrade handshake, bidirectional message relay, connection lifecycle, and concurrent connection handling.

Output: relayer/websocket_test.go with comprehensive WebSocket transport tests
</objective>

<execution_context>
@/home/overlordyorch/.claude/get-shit-done/workflows/execute-plan.md
@/home/overlordyorch/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-characterization-tests/02-VERIFICATION.md
@.planning/phases/02-characterization-tests/02-04-SUMMARY.md
@relayer/websocket.go
@relayer/proxy.go
@relayer/proxy_test.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WebSocket transport characterization tests</name>
  <files>relayer/websocket_test.go</files>
  <action>
    Create `relayer/websocket_test.go` with characterization tests for the WebSocket transport layer.

    **Build tag:** `//go:build test` at the top of file.

    **Test approach:**
    - Use `httptest.Server` for the backend WebSocket server (gorilla/websocket Upgrader)
    - Use `gorilla/websocket.Dial` as the client
    - Use `testutil/keys.go` for deterministic test keys and `testutil/redis_suite.go` for miniredis setup (plan 06 fixes the import cycle)
    - Use local mock types ONLY for package-specific dependencies that testutil cannot provide (e.g., mock WebSocket backends)
    - All tests must be deterministic and pass `-race`

    **Required test cases (characterizing websocket.go behavior):**

    1. **TestWebSocketUpgrade_Success**: Valid WebSocket upgrade request returns 101 Switching Protocols
    2. **TestWebSocketUpgrade_MissingHeaders**: Request without WebSocket upgrade headers returns appropriate error
    3. **TestWebSocketUpgrade_BackendUnavailable**: WebSocket upgrade when backend is down returns error
    4. **TestWebSocketMessage_TextRelay**: Client sends text message, backend receives it, backend responds, client receives response
    5. **TestWebSocketMessage_BinaryRelay**: Same as text but with binary message type
    6. **TestWebSocketConnection_ClientClose**: Client sends close frame, connection tears down cleanly
    7. **TestWebSocketConnection_BackendClose**: Backend sends close frame, client receives close
    8. **TestWebSocketConnection_PingPong**: Verify ping/pong handling for keepalive
    9. **TestWebSocketConcurrent_MultipleConnections**: Multiple simultaneous WebSocket connections are independent
    10. **TestWebSocketConcurrent_MessageBurst**: Many messages sent rapidly on a single connection

    **Pattern for each test:**
    ```go
    func TestWebSocket_CaseName(t *testing.T) {
        // 1. Create backend WebSocket server (httptest.Server + gorilla upgrader)
        // 2. Create proxy/handler pointing to backend
        // 3. Create WebSocket client connection to proxy
        // 4. Execute test scenario
        // 5. Assert expected behavior
        // 6. Clean up connections
    }
    ```

    **Important constraints:**
    - Do NOT use time.Sleep for synchronization. Use channels, sync.WaitGroup, or require.Eventually.
    - Import testutil for shared helpers (keys, redis suite). Use local helpers only for WebSocket-specific mocks.
    - Use `t.Parallel()` where tests are independent.
    - Include message assertion: verify the exact bytes relayed match what was sent.
    - Document any surprising behavior discovered (as comments, not fixes).

    **Study websocket.go first** to understand:
    - How the proxy upgrades connections (`handleWebSocket` or equivalent function)
    - How messages are relayed between client and backend
    - How connection close is handled
    - What error conditions exist
    - What headers are forwarded during upgrade
  </action>
  <verify>
    ```bash
    # Tests compile
    go build -tags test ./relayer/...

    # Tests pass with race detector
    go test -tags test -race -v -run TestWebSocket ./relayer/...

    # Tests pass with shuffle
    go test -tags test -race -shuffle=on ./relayer/...

    # No flaky failures (run 5 times)
    for i in $(seq 1 5); do go test -tags test -race -shuffle=on -run TestWebSocket ./relayer/... || exit 1; done
    ```
  </verify>
  <done>
    relayer/websocket_test.go exists with 10+ WebSocket characterization tests. All pass with -race and -shuffle=on. No flaky failures in 5 consecutive runs.
  </done>
</task>

</tasks>

<verification>
1. `go test -tags test -race -v -run TestWebSocket ./relayer/...` passes all WebSocket tests
2. `go test -tags test -race -shuffle=on -count=5 ./relayer/...` passes (no flaky tests)
3. WebSocket test file has >= 300 lines of test code
4. Tests cover: upgrade, message relay, connection lifecycle, concurrent connections
</verification>

<success_criteria>
- WebSocket transport has comprehensive characterization tests
- All tests pass -race and -shuffle=on deterministically
- CHAR-03 WebSocket gap is closed
</success_criteria>

<output>
After completion, create `.planning/phases/02-characterization-tests/02-07-SUMMARY.md`
</output>
