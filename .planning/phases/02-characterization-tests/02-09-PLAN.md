---
phase: 02-characterization-tests
plan: 09
type: execute
wave: 2
depends_on: [02-06]
files_modified:
  - miner/deduplicator_test.go
  - miner/session_store_test.go
  - miner/session_coordinator_test.go
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Duplicate relays are rejected and unique relays are accepted across concurrent operations"
    - "Session metadata persists correctly across save/get/update/delete lifecycle in Redis"
    - "New sessions are discovered from relay traffic and subsequent relays route to the correct existing session"
    - "Concurrent relay arrivals for the same new session create exactly one session (no duplicates)"
    - "All new miner tests pass with -race flag and use miniredis"
    - "Miner/ coverage reaches >= 50% (up from 32.4% baseline; 80% enforcement deferred to Phase 6 per ROADMAP.md success criterion 2)"
  artifacts:
    - path: "miner/deduplicator_test.go"
      provides: "Deduplicator characterization tests"
      min_lines: 200
    - path: "miner/session_store_test.go"
      provides: "Session store characterization tests"
      min_lines: 200
    - path: "miner/session_coordinator_test.go"
      provides: "Session coordinator characterization tests"
      min_lines: 250
  key_links:
    - from: "miner/deduplicator_test.go"
      to: "miner/deduplicator.go"
      via: "Direct function calls with miniredis"
      pattern: "Deduplicat"
    - from: "miner/session_store_test.go"
      to: "miner/session_store.go"
      via: "Direct function calls with miniredis"
      pattern: "SessionStore"
    - from: "miner/session_coordinator_test.go"
      to: "miner/session_coordinator.go"
      via: "Direct function calls"
      pattern: "SessionCoordinator"
    - from: "miner/deduplicator_test.go"
      to: "testutil/keys.go"
      via: "Import for deterministic test keys"
      pattern: "testutil\\.TestKeys\\|testutil\\.SupplierKey"
    - from: "miner/session_store_test.go"
      to: "testutil/redis_suite.go"
      via: "Import for miniredis setup helpers"
      pattern: "testutil\\.NewRedisTestSuite\\|testutil\\.Redis"
    - from: "miner/session_coordinator_test.go"
      to: "testutil/session_builder.go"
      via: "Import for deterministic session test data"
      pattern: "testutil\\.NewSessionBuilder\\|testutil\\.Session"
---

<objective>
Add characterization tests for critical miner components to increase miner/ coverage toward 80%.

Purpose: Miner coverage is at 32.4%. The deduplicator (prevents double-counting relays), session store (Redis-backed session state), and session coordinator (orchestrates session lifecycle) are core "money path" components that need characterization. These are the highest-impact untested files for coverage improvement.

Output: Three new test files characterizing deduplicator, session store, and session coordinator behavior
</objective>

<execution_context>
@/home/overlordyorch/.claude/get-shit-done/workflows/execute-plan.md
@/home/overlordyorch/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-characterization-tests/02-VERIFICATION.md
@.planning/phases/02-characterization-tests/02-02-SUMMARY.md
@.planning/phases/02-characterization-tests/02-03-SUMMARY.md
@miner/deduplicator.go
@miner/session_store.go
@miner/session_coordinator.go
@miner/redis_smst_utils_test.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create deduplicator and session store characterization tests</name>
  <files>
    miner/deduplicator_test.go
    miner/session_store_test.go
  </files>
  <action>
    **Build tag:** `//go:build test` at the top of both files.

    **deduplicator_test.go:**

    Read `miner/deduplicator.go` to understand:
    - How relay hashes are tracked (Redis Sets)
    - The IsDuplicate/MarkSeen interface
    - TTL behavior for dedup keys
    - Key format (ha:miner:dedup:session:{sessionID})

    Create tests following the RedisSMSTTestSuite pattern (miniredis, FlushAll between tests):

    1. **TestDeduplicator_FirstRelayNotDuplicate**: New relay hash returns false (not seen)
    2. **TestDeduplicator_DuplicateRelayDetected**: Same hash seen twice returns true on second call
    3. **TestDeduplicator_DifferentSessionsIndependent**: Same hash in different sessions are independent
    4. **TestDeduplicator_MultipleRelaysTracked**: Multiple different hashes tracked correctly
    5. **TestDeduplicator_CleanupRemovesEntries**: Session cleanup removes dedup entries
    6. **TestDeduplicator_ConcurrentDedup**: Multiple goroutines checking same hash concurrently

    **session_store_test.go:**

    Read `miner/session_store.go` to understand:
    - How session metadata is stored (Redis Strings/JSON)
    - Session index operations (add, remove, list)
    - State index operations (sessions by state)
    - Key patterns from CLAUDE.md

    Create tests:

    1. **TestSessionStore_SaveAndGet**: Save session metadata, retrieve it, verify fields match
    2. **TestSessionStore_UpdateState**: Update session state, verify index moves correctly
    3. **TestSessionStore_ListByState**: List sessions filtered by state (ACTIVE, CLAIMING, etc.)
    4. **TestSessionStore_DeleteSession**: Delete session removes from all indexes
    5. **TestSessionStore_NonExistentSession**: Get non-existent session returns appropriate error
    6. **TestSessionStore_ConcurrentUpdates**: Multiple goroutines updating different sessions concurrently

    **Pattern:** Follow existing miner test patterns. Use suite-based tests with miniredis. Use `testutil/keys.go` for deterministic test keys, `testutil/redis_suite.go` for miniredis setup, and `testutil/session_builder.go` for test session data (plan 06 fixes the import cycle). Use local mock types only for miner-specific dependencies that testutil cannot provide. All mocks must be thread-safe with mutexes.
  </action>
  <verify>
    ```bash
    # Tests compile
    go build -tags test ./miner/...

    # Tests pass with race detector
    go test -tags test -race -v -run "TestDeduplicator|TestSessionStore" ./miner/...

    # Tests pass with shuffle
    go test -tags test -race -shuffle=on -run "TestDeduplicator|TestSessionStore" ./miner/...
    ```
  </verify>
  <done>
    deduplicator_test.go has 6+ tests. session_store_test.go has 6+ tests. All pass with -race and -shuffle=on.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create session coordinator characterization tests</name>
  <files>miner/session_coordinator_test.go</files>
  <action>
    **Build tag:** `//go:build test` at the top of file.

    Read `miner/session_coordinator.go` to understand:
    - How sessions are discovered from relay traffic
    - How relays are routed to the correct session
    - How the coordinator interacts with session lifecycle and session store
    - Error handling for invalid sessions or unknown suppliers

    Create tests following the existing suite patterns:

    1. **TestSessionCoordinator_DiscoverNewSession**: First relay for a session triggers session creation
    2. **TestSessionCoordinator_RouteRelayToExisting**: Subsequent relays route to existing session
    3. **TestSessionCoordinator_MultipleSuppliers**: Sessions are isolated per supplier
    4. **TestSessionCoordinator_InvalidSession**: Relay with invalid session data returns error
    5. **TestSessionCoordinator_SessionExpired**: Relay for expired session returns appropriate error
    6. **TestSessionCoordinator_ConcurrentDiscovery**: Multiple relays arriving simultaneously for new session create exactly one session
    7. **TestSessionCoordinator_RelayAccumulation**: Multiple relays increase relay count correctly

    **Important:** The coordinator ties together deduplicator + session store + session lifecycle. Use testutil helpers for test keys and session data. Mock miner-specific dependencies (lifecycle, store interfaces) using local mock types where testutil does not provide them. The coordinator tests should verify the orchestration logic, not re-test individual component behavior.

    **Constraints:**
    - Use miniredis for any Redis operations
    - All mocks must be thread-safe
    - No time.Sleep - use channels/WaitGroups for synchronization
    - Document actual behavior (characterization, not prescription)
  </action>
  <verify>
    ```bash
    # Tests compile
    go build -tags test ./miner/...

    # Tests pass with race detector
    go test -tags test -race -v -run TestSessionCoordinator ./miner/...

    # Tests pass with shuffle
    go test -tags test -race -shuffle=on -run TestSessionCoordinator ./miner/...

    # Run coverage to see improvement
    go test -tags test -race -coverprofile=/tmp/miner.cover ./miner/... && go tool cover -func=/tmp/miner.cover | grep total
    ```
  </verify>
  <done>
    session_coordinator_test.go has 7+ tests. All pass with -race and -shuffle=on. Miner coverage is >= 50% (up from 32.4% baseline).
  </done>
</task>

</tasks>

<verification>
1. `go test -tags test -race -v -run "TestDeduplicator|TestSessionStore|TestSessionCoordinator" ./miner/...` passes
2. `go test -tags test -race -shuffle=on -count=3 ./miner/...` passes (no flaky tests)
3. Combined: 19+ new tests across 3 files
4. Miner coverage >= 50% (up from 32.4% baseline; 80% enforcement deferred to Phase 6)
</verification>

<success_criteria>
- Deduplicator, session store, and session coordinator have characterization tests
- All new tests use miniredis, pass -race, run deterministically
- Miner/ coverage >= 50% (80% enforcement deferred to Phase 6 per ROADMAP.md success criterion 2)
</success_criteria>

<output>
After completion, create `.planning/phases/02-characterization-tests/02-09-SUMMARY.md`
</output>
