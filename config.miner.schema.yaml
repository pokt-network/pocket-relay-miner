$schema: http://json-schema.org/draft-07/schema#
title: Pocket RelayMiner Miner Configuration
description: Configuration schema for the Pocket RelayMiner Miner component (stateful claim/proof submitter with leader election)
type: object
required:
  - redis
  - pocket_node
  - keys

properties:
  redis:
    type: object
    description: Redis connection configuration
    required:
      - url
    properties:
      url:
        type: string
        description: Redis connection URL
        pattern: ^redis(s)?://
        examples:
          - redis://localhost:6379
          - redis://redis-node1:6379,redis-node2:6379
      consumer_name:
        type: string
        description: Unique consumer name for this miner instance (auto-generated from hostname if not set)
      claim_idle_timeout_ms:
        type: integer
        description: Timeout for reclaiming idle messages from crashed consumers
        default: 60000
        minimum: 1000
      pool_size:
        type: integer
        description: Maximum number of socket connections (0 = use default 20 × GOMAXPROCS)
        default: 0
        minimum: 0
      min_idle_conns:
        type: integer
        description: Minimum number of idle connections to keep warm (0 = use default pool_size / 4)
        default: 0
        minimum: 0
      pool_timeout_seconds:
        type: integer
        description: Wait time for connection from pool in seconds (0 = use default 4s)
        default: 0
        minimum: 0
      conn_max_idle_time_seconds:
        type: integer
        description: Close idle connections after this many seconds (0 = use default 300s)
        default: 0
        minimum: 0
      namespace:
        type: object
        description: Redis key namespace configuration (defaults match historical "ha:" prefix structure)
        properties:
          base_prefix:
            type: string
            description: Root prefix for all Redis keys
            default: ha
          cache_prefix:
            type: string
            description: Cache data prefix (full key: {base_prefix}:{cache_prefix}:*)
            default: cache
          events_prefix:
            type: string
            description: Pub/sub channels prefix (full key: {base_prefix}:{events_prefix}:*)
            default: events
          streams_prefix:
            type: string
            description: Relay streams prefix (full key: {base_prefix}:{streams_prefix}:*)
            default: relays
          miner_prefix:
            type: string
            description: Miner state prefix (full key: {base_prefix}:{miner_prefix}:*)
            default: miner
          supplier_prefix:
            type: string
            description: Supplier data prefix (full key: {base_prefix}:{supplier_prefix}:*)
            default: supplier
          meter_prefix:
            type: string
            description: Metering data prefix (full key: {base_prefix}:{meter_prefix}:*)
            default: meter
          params_prefix:
            type: string
            description: Cached params prefix (full key: {base_prefix}:{params_prefix}:*)
            default: params
          consumer_group_prefix:
            type: string
            description: Consumer group name suffix (full name: {base_prefix}-{consumer_group_prefix})
            default: miners

  pocket_node:
    type: object
    description: Pocket blockchain connection configuration
    required:
      - query_node_rpc_url
      - query_node_grpc_url
    properties:
      query_node_rpc_url:
        type: string
        description: RPC endpoint for queries and block subscription
        examples:
          - https://rpc.testnet.pokt.network
          - http://localhost:26657
      query_node_grpc_url:
        type: string
        description: gRPC endpoint for queries
        examples:
          - grpc.testnet.pokt.network:443
          - localhost:9090
      chain_id:
        type: string
        description: Blockchain chain ID for transaction signing. MUST match the network. Defaults to "pocket" (mainnet).
        default: pocket
        examples:
          - pocket
          - pocket-beta
      grpc_insecure:
        type: boolean
        description: Disable TLS for gRPC connections (use for local development only)
        default: false

  transaction:
    type: object
    description: Transaction configuration for claim/proof submission
    properties:
      gas_limit:
        type: integer
        description: Gas limit for transactions. Set to 0 for automatic gas estimation (simulation). Set to a positive value for fixed gas limit.
        default: 0
        minimum: 0
      gas_price:
        type: string
        description: Gas price in upokt (e.g., "0.00001upokt")
        default: "0.00001upokt"
        pattern: ^[0-9]+(\\.[0-9]+)?upokt$
      gas_adjustment:
        type: number
        description: Gas adjustment multiplier applied to simulated gas (only used when gas_limit=0)
        default: 1.7
        minimum: 1.0

  keys:
    type: object
    description: Supplier signing key configuration
    properties:
      keys_file:
        type: string
        description: Path to YAML file with hex-encoded private keys
      keys_dir:
        type: string
        description: Directory containing individual key files
      keyring:
        type: object
        description: Cosmos SDK keyring configuration
        properties:
          backend:
            type: string
            enum:
              - file
              - os
              - test
              - memory
            description: Keyring backend type
          dir:
            type: string
            description: Directory for keyring (file backend only)
          app_name:
            type: string
            description: Application name for keyring
            default: pocket
          key_names:
            type: array
            description: Specific key names to load (empty = load all)
            items:
              type: string

  metrics:
    type: object
    description: Prometheus metrics server configuration
    properties:
      enabled:
        type: boolean
        description: Enable metrics collection
        default: true
      addr:
        type: string
        description: Metrics HTTP server address
        default: ":9092"
        pattern: ^.*:[0-9]+$

  pprof:
    type: object
    description: Prometheus metrics server configuration
    properties:
      enabled:
        type: boolean
        description: Enable pprof profiling server (for debugging, disable in production)
        default: true
      addr:
        type: string
        description: Pprof HTTP server address (use localhost for security)
        default: ":6060"
        pattern: ^.*:[0-9]+$

  logging:
    type: object
    description: Logging configuration
    properties:
      level:
        type: string
        enum:
          - trace
          - debug
          - info
          - warn
          - error
        default: info
      format:
        type: string
        enum:
          - json
          - text
        default: json
      output:
        type: string
        description: Log output destination
        default: stdout
      async:
        type: boolean
        description: Enable async logging for better performance
        default: true
      async_buffer_size:
        type: integer
        description: Async log buffer size
        default: 100000
        minimum: 1000
      enable_caller:
        type: boolean
        description: Add caller file:line to log events. Useful for debugging but adds ~14% allocation overhead under high throughput. Disable in production.
        default: false

  block_time_seconds:
    type: integer
    description: Expected block time in seconds (30s for mainnet/testnet, 6s for localnet)
    default: 30
    minimum: 1

  block_health_monitor:
    type: object
    description: Block health monitoring configuration (Feature 1)
    properties:
      enabled:
        type: boolean
        description: Enable block health monitoring
        default: false
      slowness_threshold:
        type: number
        description: Alert when blocks arrive slower than threshold × configured time
        default: 1.5
        minimum: 1.0

  default_service_factor:
    type: number
    description: Global serviceFactor applied to all services. If set, effectiveLimit = appStake × serviceFactor. If 0 or unset, use baseLimit formula.
    default: 0
    minimum: 0

  service_factors:
    type: object
    description: Per-service serviceFactor overrides. Key is serviceID, value is serviceFactor.
    additionalProperties:
      type: number
      minimum: 0

  balance_monitor:
    type: object
    description: Balance and stake monitoring configuration (Feature 4)
    properties:
      enabled:
        type: boolean
        description: Enable balance/stake monitoring
        default: true
      check_interval_seconds:
        type: integer
        description: How often to check balance/stake (seconds)
        default: 300
        minimum: 60
      balance_threshold_upokt:
        type: integer
        description: Alert when balance falls below this threshold (upokt, 1 POKT = 1,000,000 upokt)
        default: 1000000
        minimum: 0
      stake_warning_proof_threshold:
        type: integer
        description: Alert when remaining missed proofs before auto-unstake falls below this threshold
        default: 10
        minimum: 1
      stake_critical_proof_threshold:
        type: integer
        description: Critical alert when remaining missed proofs before auto-unstake falls below this threshold
        default: 3
        minimum: 1

  session_lifecycle:
    type: object
    description: Session lifecycle configuration (event-driven via block events)
    properties:
      max_concurrent_transitions:
        type: integer
        description: Max number of sessions transitioning simultaneously
        default: 10
        minimum: 1

  worker_pools:
    type: object
    description: Worker pool configuration for parallel processing. Auto-sizing formula - max(cpu × cpu_multiplier, suppliers × workers_per_supplier) + overhead
    properties:
      master_pool_size:
        type: integer
        description: Total master pool size (0 = auto-calculate based on CPU and supplier count)
        default: 0
        minimum: 0
      cpu_multiplier:
        type: integer
        description: Multiplier for CPU-based sizing baseline (cpu_count × multiplier)
        default: 4
        minimum: 1
      workers_per_supplier:
        type: integer
        description: Workers allocated per supplier for claim/proof building
        default: 2
        minimum: 1
      query_workers:
        type: integer
        description: Fixed workers for blockchain queries (startup, cache refresh)
        default: 20
        minimum: 1
      settlement_workers:
        type: integer
        description: Fixed workers for settlement event processing
        default: 2
        minimum: 1

  leader_election:
    type: object
    description: Distributed leader election configuration (HA deployments)
    properties:
      leader_ttl_seconds:
        type: integer
        description: How long leader lock lasts before expiring (seconds)
        default: 30
        minimum: 5
      heartbeat_rate_seconds:
        type: integer
        description: How often to attempt acquire/renew leadership (seconds)
        default: 10
        minimum: 1

  deduplication_ttl_blocks:
    type: integer
    description: How many blocks to keep relay hashes for deduplication
    default: 10
    minimum: 1

  batch_size:
    type: integer
    description: Number of messages to fetch per XREADGROUP operation
    default: 1000
    minimum: 1

  ack_batch_size:
    type: integer
    description: Number of messages to acknowledge in a batch
    default: 50
    minimum: 1

  hot_reload_enabled:
    type: boolean
    description: Enable hot-reload of supplier keys
    default: true

  session_ttl:
    type: string
    description: TTL for session data (duration string, e.g., "24h")
    default: 24h
    pattern: ^[0-9]+(ns|us|µs|ms|s|m|h)$

  cache_ttl:
    type: string
    description: TTL for Redis cached data (sessions, SMST trees). Backup safety net - manual cleanup is primary.
    default: 2h
    pattern: ^[0-9]+(ns|us|µs|ms|s|m|h)$

  submission_tracking_ttl:
    type: string
    description: TTL for claim/proof submission tracking records. Used for debugging failed submissions and auditing via `pocket-relay-miner redis submissions`.
    default: 24h
    pattern: ^[0-9]+(ns|us|µs|ms|s|m|h)$

  known_applications:
    type: array
    description: Application addresses to pre-discover at startup
    items:
      type: string
      description: Application address (bech32)
